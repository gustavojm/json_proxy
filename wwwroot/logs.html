<style>
	.log {
		font-family: monospace;
		white-space: pre-wrap; /* Preserves whitespace and wraps lines */
		padding: 10px;
		border: 1px solid #ccc;
		height: 80%;
		overflow-y: scroll;
	}

	.Debug {
		color: black;
	}

	.Info {
		color: green;
	}

	.Warning {
		color: orange;
	}

	.Error {
		color: red;
	}
</style>

<div id="logs_tab" style="overflow: hidden; width: 100%;" class="tabs-div">
	<div style="margin-bottom: 10px;">
	Change Log Level: 
		<select id="log_level">
			<option>Choose a Tool</option>
			<option class="Debug" value="Debug">Debug</option>
			<option class="Info" value="Info">Info</option>
			<option class="Warning" value="Warning">Warning</option>
			<option class="Error" value="Error">Error</option>
		</select>
	</div>

	<div id="logViewer" class="log"></div>	
	<div style="display: flex; width: 100%; margin-top: 5px;">
		<div style="display: flex; float: left; width: 50%;">
			<input type="button" id="clear_logs" value="Clear Logs">
			<input type="button" id="save_logs_to_file" value="Save to File">
		</div>
		<div style="width: 50%; margin-left: auto; margin-right: 0;">
			<div style="display: flex; float: right; width: 40%;">
				<div id="free_mem" class="progress-bar">
					<div class="progress"></div>
					<div class="progress-min-mark"></div>
					<div class="progress-text"></div>
				</div>
			</div>				  				
			<div style="display: flex; float: right; margin-right: 5px; height: 20px; align-items: center; position: relative;">Free Heap Memory: </div>
		</div>
	</div>		
</div>

<script type="text/javascript">

	var timer_logs

	function addLogEntry(message, severity) {
        var logEntry = $('<div>').addClass(severity).text(message);
        $('#logViewer').append(logEntry);
    }
	
	function get_logs() {
		$.ajax({
			url : "/REMA/",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify({
				commands : [ {
					command : "LOGS",
					pars : {
						quantity : 10
					}
				},
				{
					command : "MEM_INFO"
				} 
			 ]
			}),
			dataType : "json",
			success : function(data) {
				$.each(data.LOGS.DEBUG_MSGS, function(key, entry) {
					entry_arr = entry.split("|");
					addLogEntry("[" + entry_arr[0] + "] " + entry_arr[1], entry_arr[0]);
				});
				
				mem_free = (data.MEM_INFO.MEM_FREE / data.MEM_INFO.MEM_TOTAL * 100).toFixed(1);
									mem_free_text = ((data.MEM_INFO.MEM_FREE/1024).toFixed(1) || 0) + "k(" + mem_free + "%)"
									if (isNaN(mem_free)) {
										mem_free = 0;
										mem_free_text = "---";
									}									

				mem_min_free = (data.MEM_INFO.MEM_MIN_FREE / data.MEM_INFO.MEM_TOTAL * 100).toFixed(1);

				$("#free_mem .progress").css("width", mem_free+"%");
				$("#free_mem .progress-text").text(mem_free_text);
				$("#free_mem .progress-min-mark").css("left", mem_min_free+"%");				
			}
		})
	}

	function saveToFile() {
		var textarea = document.getElementById(("logViewer"));

		var textToSave = ""
		console.log($("#logViewer").children());
		$.each($("#logViewer").children(), function(key, entry) {
			textToSave += $(entry).text() + "\n";
		});
		
		console.log(textToSave);
		
		var blob = new Blob([textToSave], { type: 'text/plain' });
		var link = document.createElement('a');
		link.href = URL.createObjectURL(blob);
		link.download = 'content.txt';
		link.click();
		URL.revokeObjectURL(link.href);
	}

	$(function() {
		timer_logs = setInterval(get_logs, 1000);
		
		$("#clear_logs").click(function(){
			$('#logViewer').empty();
		});

		$("#save_logs_to_file").click(function(){
			saveToFile();
		});
	
		$('.ui-tabs-tab').on('unload_tab',function() {
			clearInterval(timer_logs);
		    timer_logs = null;		
		});

		$("#log_level").change(function(e) {
			var level = $("option:selected", this).val();
			var level_class = $("option:selected", this).attr("class");
			$.ajax({
				url : "/REMA/",
				method : "POST",
				contentType : "application/json",
				data : JSON.stringify({
					commands : [ {
						command : "SET_LOG_LEVEL",
						pars : {
							net_level : level
						}
					},
					]
				}),
				dataType : "json",
				success : function(data) {				
					$("#log_level").removeClass().addClass(level_class);
				}
			});
		});
	});
	

</script>